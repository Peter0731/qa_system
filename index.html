<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QA測試進度追蹤系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background-color: #f0f4f8; }
        .card { transition: all 0.3s cubic-bezier(0.22, 1, 0.36, 1); }
        .card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            cursor: text; /* 這行會讓卡片hover時游標變I型 */
        }
        .board-column { min-height: 70vh; }
        .status-not-started { background-color: #FEF3C7; }
        .status-in-progress { background-color: #DBEAFE; }
        .status-completed { background-color: #D1FAE5; }
        .status-retested { background-color: #EDE9FE; }
        .delete-btn { transition: all 0.2s ease; }
        .delete-btn:hover { transform: scale(1.2); }
        .edit-btn { transition: all 0.2s ease; }
        .edit-btn:hover { transform: scale(1.2); }
        .notification { animation: fadeOut 3s forwards; animation-delay: 2s; }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; visibility: hidden; } }
        .drag-handle { cursor: grab; user-select: none; color: #9ca3af; display: flex; align-items: center; height: 100%; }
        .card { display: flex; align-items: center; gap: 0.75rem; }
        .card .flex-1 { width: 100%; }
        .modal-content-scroll { max-height: 95vh; overflow-y: auto; }
        .drag-ghost { opacity: 0.6; background: #dbeafe !important; }
        .drag-chosen { box-shadow: 0 0 0 3px #2563eb22; background: #fff !important; z-index: 20; }
        .line-through { text-decoration: line-through; text-decoration-thickness: 2px; text-decoration-color: #6b7280 !important; }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-2 inline-block">QA測試進度追蹤系統</h1>
        </header>

        <div id="notification-area" class="fixed top-4 right-4 z-50"></div>

        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <div class="flex flex-col md:flex-row gap-4 items-center">
                <div class="flex-grow">
                    <div class="relative">
                        <input id="search-input" type="text" placeholder="搜尋測試項目..." class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <div class="absolute left-3 top-2.5 text-gray-400">
                            <i class="fas fa-search"></i>
                        </div>
                    </div>
                </div>
                <div>
                    <button id="add-card-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center whitespace-nowrap">
                        <i class="fas fa-plus mr-2"></i> 新增測試卡片
                    </button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="bg-white rounded-lg shadow">
                <div class="bg-yellow-100 p-4 rounded-t-lg">
                    <h2 class="text-lg font-bold text-yellow-800 flex items-center">
                        <i class="fas fa-clipboard-list mr-2"></i> 尚未測試
                        <span id="not-started-count" class="ml-2 bg-yellow-200 text-yellow-800 px-2 py-1 rounded-full text-sm">0</span>
                    </h2>
                </div>
                <div id="not-started" class="board-column p-4 space-y-4" data-status="not-started"></div>
            </div>
            <div class="bg-white rounded-lg shadow">
                <div class="bg-blue-100 p-4 rounded-t-lg">
                    <h2 class="text-lg font-bold text-blue-800 flex items-center">
                        <i class="fas fa-spinner mr-2"></i> 正在進行
                        <span id="in-progress-count" class="ml-2 bg-blue-200 text-blue-800 px-2 py-1 rounded-full text-sm">0</span>
                    </h2>
                </div>
                <div id="in-progress" class="board-column p-4 space-y-4" data-status="in-progress"></div>
            </div>
            <div class="bg-white rounded-lg shadow">
                <div class="bg-green-100 p-4 rounded-t-lg">
                    <h2 class="text-lg font-bold text-green-800 flex items-center">
                        <i class="fas fa-check-circle mr-2"></i> 已完成測試
                        <span id="completed-count" class="ml-2 bg-green-200 text-green-800 px-2 py-1 rounded-full text-sm">0</span>
                    </h2>
                </div>
                <div id="completed" class="board-column p-4 space-y-4" data-status="completed"></div>
            </div>
            <div class="bg-white rounded-lg shadow">
                <div class="bg-purple-100 p-4 rounded-t-lg">
                    <h2 class="text-lg font-bold text-purple-800 flex items-center">
                        <i class="fas fa-check-double mr-2"></i> 已完成複測
                        <span id="retested-count" class="ml-2 bg-purple-200 text-purple-800 px-2 py-1 rounded-full text-sm">0</span>
                    </h2>
                </div>
                <div id="retested" class="board-column p-4 space-y-4" data-status="retested"></div>
            </div>
        </div>
    </div>

    <!-- 新增/編輯卡片的彈出視窗 -->
    <div id="card-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-md sm:p-6 p-3 mx-4 modal-content-scroll">
            <div class="flex justify-between items-center sm:mb-4 mb-[1px] sm:px-0 px-4 sm:py-0 py-4">
                <h3 id="modal-title" class="text-xl font-bold">新增測試卡片</h3>
                <button id="close-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <!-- 這裡加上 sm:px-0 px-2，讓內容在手機左右縮排 -->
            <form id="card-form" class="sm:px-0 px-4 sm:py-0 py-4">
                <input type="hidden" id="card-id">
                <div class="mb-4">
                    <label for="card-section" class="block text-gray-700 font-medium mb-2">測試章節</label>
                    <input type="text" id="card-section" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="card-description" class="block text-gray-700 font-medium mb-2">測試描述</label>
                    <textarea id="card-description" rows="3" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <div class="mb-4">
                    <label for="card-date" class="block text-gray-700 font-medium mb-2">日期</label>
                    <input type="date" id="card-date" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <!-- 已修正 -->
                <div class="mb-4 flex items-center">
                    <input type="checkbox" id="card-fixed" class="mr-2">
                    <label for="card-fixed" class="text-gray-700 font-medium select-none">已修正</label>
                </div>
                <div class="mb-4">
                    <label for="card-status" class="block text-gray-700 font-medium mb-2">測試狀態</label>
                    <select id="card-status" class="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="not-started">尚未測試</option>
                        <option value="in-progress">正在進行</option>
                        <option value="completed">已完成測試</option>
                        <option value="retested">已完成複測</option>
                    </select>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" id="cancel-btn" class="px-4 py-2 border rounded-lg hover:bg-gray-100">取消</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">儲存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 刪除確認彈出視窗 -->
    <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-md sm:p-6 p-3 mx-4 modal-content-scroll">
            <div class="text-center mb-6">
                <div class="text-red-500 text-5xl mb-4">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">確認刪除</h3>
                <p class="text-gray-600">您確定要刪除這張測試卡片嗎？此操作無法復原。</p>
            </div>
            <div class="flex justify-center gap-4">
                <button id="cancel-delete" class="px-6 py-2 border rounded-lg hover:bg-gray-100">取消</button>
                <button id="confirm-delete" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg">確認刪除</button>
            </div>
        </div>
    </div>

    <!-- JS 區塊 -->
    <script>
    const API_URL = 'db.php';
    let cards = [];
    let isSorting = false;  // 拖曳狀態

    let currentSearchTerm = '';  // << 新增: 儲存目前搜尋字串

    // DOM 元素
    const notStartedColumn = document.getElementById('not-started');
    const inProgressColumn = document.getElementById('in-progress');
    const completedColumn = document.getElementById('completed');
    const retestedColumn = document.getElementById('retested');
    const searchInput = document.getElementById('search-input');
    const addCardBtn = document.getElementById('add-card-btn');
    const cardModal = document.getElementById('card-modal');
    const deleteModal = document.getElementById('delete-modal');
    const modalTitle = document.getElementById('modal-title');
    const closeModal = document.getElementById('close-modal');
    const cancelBtn = document.getElementById('cancel-btn');
    const cancelDelete = document.getElementById('cancel-delete');
    const confirmDelete = document.getElementById('confirm-delete');
    const cardForm = document.getElementById('card-form');
    const cardIdInput = document.getElementById('card-id');
    const cardSectionInput = document.getElementById('card-section');
    const cardDescriptionInput = document.getElementById('card-description');
    const cardStatusInput = document.getElementById('card-status');
    const cardDateInput = document.getElementById('card-date');
    const cardFixedInput = document.getElementById('card-fixed');
    const notificationArea = document.getElementById('notification-area');

    // 計數器元素
    const notStartedCount = document.getElementById('not-started-count');
    const inProgressCount = document.getElementById('in-progress-count');
    const completedCount = document.getElementById('completed-count');
    const retestedCount = document.getElementById('retested-count');

    let currentDeleteId = null;

    async function initPage() {
        await loadCardsFromServer();
        renderCards();
        updateCounters();
    }

    async function loadCardsFromServer() {
        try {
            const res = await fetch(API_URL);
            cards = await res.json();
        } catch (e) {
            cards = [];
            showNotification('無法載入伺服器資料', 'error');
        }
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification p-3 mb-2 rounded-lg shadow-lg text-white ${
            type === 'success' ? 'bg-green-600' : 
            type === 'error' ? 'bg-red-600' : 'bg-blue-600'
        }`;
        notification.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-${
                    type === 'success' ? 'check-circle' : 
                    type === 'error' ? 'exclamation-circle' : 'info-circle'
                } mr-2"></i>
                <span>${message}</span>
            </div>
        `;
        notificationArea.appendChild(notification);
        setTimeout(() => { notification.remove(); }, 5000);
    }

    /**
     * 渲染卡片（可支援過濾）
     * 如果 filteredCards 為 null，會自動依 currentSearchTerm 做過濾
     */
    function renderCards(filteredCards = null) {
        notStartedColumn.innerHTML = '';
        inProgressColumn.innerHTML = '';
        completedColumn.innerHTML = '';
        retestedColumn.innerHTML = '';

        let cardsToRender = filteredCards;
        // 如果 filteredCards 沒帶，且目前搜尋有條件，則過濾
        if (!cardsToRender && currentSearchTerm) {
            const searchTerm = currentSearchTerm.toLowerCase();
            cardsToRender = cards.filter(card => 
                card.section.toLowerCase().includes(searchTerm) ||
                card.description.toLowerCase().includes(searchTerm)
            );
        }
        if (!cardsToRender) cardsToRender = cards;

        cardsToRender.forEach(card => {
            const cardElement = createCardElement(card);
            switch(card.status) {
                case 'not-started':
                    notStartedColumn.appendChild(cardElement); break;
                case 'in-progress':
                    inProgressColumn.appendChild(cardElement); break;
                case 'completed':
                    completedColumn.appendChild(cardElement); break;
                case 'retested':
                    retestedColumn.appendChild(cardElement); break;
            }
        });
        updateCounters();
    }

    /**
     * 建立一張卡片的 DOM 元素
     */
    function createCardElement(card) {
        const cardDiv = document.createElement('div');
        cardDiv.className = `card status-${card.status} bg-white border rounded-lg shadow-sm p-4 cursor-pointer flex items-center gap-3`;
        cardDiv.dataset.id = card.id;

        // 拖曳 handle
        const dragHandle = document.createElement('div');
        dragHandle.className = 'drag-handle';
        dragHandle.innerHTML = '<i class="fas fa-bars fa-lg"></i>';

        // 內容區
        const contentDiv = document.createElement('div');
        contentDiv.className = 'flex-1';

        // 章節標題加刪除線
        const header = document.createElement('div');
        header.className = 'mb-2';
        header.innerHTML = `<h3 class="font-bold${card.fixed ? ' line-through text-gray-500' : ' text-gray-800'}" style="${card.fixed ? 'text-decoration-color: #6b7280;' : ''}">${card.section}</h3>`;

        // 描述也加刪除線
        const description = document.createElement('p');
        description.className = (card.fixed ? 'line-through text-gray-500' : 'text-gray-700') + ' text-sm mb-3';
        description.style.textDecorationColor = card.fixed ? '#6b7280' : '';
        description.textContent = card.description;

        // footer同原本
        const footer = document.createElement('div');
        footer.className = 'flex justify-between items-center mt-2';
        const date = document.createElement('div');
        date.className = 'text-xs text-gray-500';
        date.textContent = card.date 
            ? card.date.replace(/-/g, '/')
            : (card.created_at ? new Date(card.created_at).toLocaleDateString() : '');

        const actions = document.createElement('div');
        actions.className = 'flex gap-2';
        actions.innerHTML = `
            <button class="edit-btn text-blue-600 hover:text-blue-800 p-1">
                <i class="fas fa-edit"></i>
            </button>
            <button class="delete-btn text-red-600 hover:text-red-800 p-1">
                <i class="fas fa-trash"></i>
            </button>
        `;
        footer.appendChild(date);
        footer.appendChild(actions);

        contentDiv.appendChild(header);
        contentDiv.appendChild(description);
        contentDiv.appendChild(footer);

        // 組合
        cardDiv.appendChild(dragHandle);
        cardDiv.appendChild(contentDiv);

        // 只監聽按鈕
        cardDiv.querySelector('.edit-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            openEditModal(card.id);
        });
        cardDiv.querySelector('.delete-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            openDeleteModal(card.id);
        });

        return cardDiv;
    }

    /**
     * 更新各狀態欄位的卡片數量
     */
    function updateCounters() {
        notStartedCount.textContent = cards.filter(card => card.status === 'not-started').length;
        inProgressCount.textContent = cards.filter(card => card.status === 'in-progress').length;
        completedCount.textContent = cards.filter(card => card.status === 'completed').length;
        retestedCount.textContent = cards.filter(card => card.status === 'retested').length;
    }

    /**
     * 開啟新增卡片的 Modal
     */
    function openAddModal() {
        modalTitle.textContent = '新增測試卡片';
        cardIdInput.value = '';
        cardSectionInput.value = '';
        cardDescriptionInput.value = '';
        cardStatusInput.value = 'not-started';
        cardDateInput.value = (new Date()).toISOString().split('T')[0];
        cardFixedInput.checked = false; // 新增時預設不勾選
        cardModal.classList.remove('hidden');
    }

    /**
     * 開啟編輯卡片的 Modal
     */
    function openEditModal(cardId) {
        const card = cards.find(c => Number(c.id) === Number(cardId));
        if (!card) return;
        modalTitle.textContent = '編輯測試卡片';
        cardIdInput.value = card.id;
        cardSectionInput.value = card.section;
        cardDescriptionInput.value = card.description;
        cardStatusInput.value = card.status;
        cardDateInput.value = card.date || (card.created_at ? new Date(card.created_at).toISOString().split('T')[0] : '');
        cardFixedInput.checked = !!card.fixed; // 編輯時顯示狀態
        cardModal.classList.remove('hidden');
    }

    /**
     * 開啟刪除卡片的 Modal
     */
    function openDeleteModal(cardId) {
        currentDeleteId = Number(cardId);
        deleteModal.classList.remove('hidden');
    }

    /**
     * 關閉卡片 Modal
     */
    function closeCardModal() {
        cardModal.classList.add('hidden');
    }

    /**
     * 關閉刪除 Modal
     */
    function closeDeleteModal() {
        deleteModal.classList.add('hidden');
        currentDeleteId = null;
    }

    /**
     * 儲存卡片（新增或更新）
     */
    async function saveCard(e) {
        e.preventDefault();
        const cardId = cardIdInput.value;
        const cardData = {
            section: cardSectionInput.value,
            description: cardDescriptionInput.value,
            status: cardStatusInput.value,
            date: cardDateInput.value,
            fixed: cardFixedInput.checked
        };
        if (cardId) {
            // 編輯
            cardData.id = Number(cardId);
            await fetch(API_URL, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(cardData)
            });
            showNotification('卡片已更新', 'success');
        } else {
            // 新增
            await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(cardData)
            });
            showNotification('新卡片已創建', 'success');
        }
        await loadCardsFromServer();
        searchCards(); // 以搜尋狀態渲染
        closeCardModal();
    }

    /**
     * 刪除卡片
     */
    async function deleteCard() {
        if (currentDeleteId) {
            await fetch(`${API_URL}?id=${currentDeleteId}`, { method: 'DELETE' });
            await loadCardsFromServer();
            searchCards(); // 以搜尋狀態渲染
            closeDeleteModal();
            showNotification('卡片已刪除', 'success');
        }
    }

    /**
     * 搜尋卡片，並渲染（同時將搜尋關鍵字存入 currentSearchTerm）
     */
    function searchCards() {
        currentSearchTerm = searchInput.value;  // 儲存搜尋條件
        if (!currentSearchTerm) {
            renderCards();
            return;
        }
        const searchTerm = currentSearchTerm.toLowerCase();
        const filtered = cards.filter(card => 
            card.section.toLowerCase().includes(searchTerm) || 
            card.description.toLowerCase().includes(searchTerm)
        );
        renderCards(filtered);
    }

    /**
     * 啟用每個看板的拖曳排序功能
     */
    function enableSortableColumns() {
        const columnIds = [
            { id: 'not-started', status: 'not-started' },
            { id: 'in-progress', status: 'in-progress' },
            { id: 'completed', status: 'completed' },
            { id: 'retested', status: 'retested' }
        ];
        columnIds.forEach(col => {
            new Sortable(document.getElementById(col.id), {
                animation: 200,
                swapThreshold: 0.65,
                handle: '.drag-handle',
                ghostClass: 'drag-ghost',
                chosenClass: 'drag-chosen',
                onStart: function () { isSorting = true; },
                onEnd: function (evt) {
                    isSorting = false;
                    const column = evt.to;
                    const newOrder = Array.from(column.children).map(child => Number(child.dataset.id));
                    fetch(API_URL, {
                        method: 'PATCH',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ order: newOrder, status: col.status })
                    }).then(() => {
                        loadCardsFromServer().then(renderCards);
                    });
                }
            });
        });
    }

    // 綁定各種事件監聽
    addCardBtn.addEventListener('click', openAddModal);
    closeModal.addEventListener('click', closeCardModal);
    cancelBtn.addEventListener('click', closeCardModal);
    cancelDelete.addEventListener('click', closeDeleteModal);
    confirmDelete.addEventListener('click', deleteCard);
    cardForm.addEventListener('submit', saveCard);
    searchInput.addEventListener('input', searchCards);

    // 初始化頁面並啟用拖曳
    initPage().then(enableSortableColumns);
    </script>
</body>
</html>